# ===================================================================
# Spring Boot + Synology PR/Issue Preview ì‹œìŠ¤í…œ
# ===================================================================
#
# ğŸ”‘ í•„ìˆ˜ GitHub Secrets
# ===================================================================
# APPLICATION_PROD_YML (ì„ íƒ): application-prod.yml ë‚´ìš©
# DOCKERHUB_USERNAME: DockerHub ì‚¬ìš©ìëª…
# DOCKERHUB_TOKEN: DockerHub ì•¡ì„¸ìŠ¤ í† í°
# SERVER_HOST: ë°°í¬ ì„œë²„ ì£¼ì†Œ
# SERVER_USER: SSH ì‚¬ìš©ìëª…
# SERVER_PASSWORD: SSH ë¹„ë°€ë²ˆí˜¸
# ===================================================================
#
# ğŸš€ ì‚¬ìš©ë²•:
#   @suh-lab server build    - PR/Issue ë¹Œë“œ ë° ë°°í¬
#   @suh-lab server destroy  - Preview í™˜ê²½ ì‚­ì œ
#   @suh-lab server status   - í˜„ì¬ ìƒíƒœ í™•ì¸
#
# ğŸ“Š ë¦¬ì†ŒìŠ¤ ë„¤ì´ë° ê·œì¹™:
#   - ì»¨í…Œì´ë„ˆ: {PROJECT_NAME}-pr-{PRë²ˆí˜¸}
#   - ì´ë¯¸ì§€: {DOCKERHUB_USERNAME}/{PROJECT_NAME}:pr-{PRë²ˆí˜¸}
#   - ë„ë©”ì¸: {PROJECT_NAME}-pr-{PRë²ˆí˜¸}.pr.suhsaechan.kr
#   - Preview URL: http://{ë„ë©”ì¸}:8079
#
# ===================================================================

name: PROJECT-SPRING-SYNOLOGY-PR-PREVIEW

# ===================================================================
# âš ï¸ [ì˜ì—­ 1] í”„ë¡œì íŠ¸ë³„ ì„¤ì • - ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ ì´ ì„¹ì…˜ë§Œ ìˆ˜ì •í•˜ì„¸ìš”
# ===================================================================
env:
  # í”„ë¡œì íŠ¸ ê³ ìœ  ì‹ë³„ì (ì»¨í…Œì´ë„ˆëª…, ì´ë¯¸ì§€ëª…, ë„ë©”ì¸ì— ì‚¬ìš©) (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  PROJECT_NAME: suh-project-utility

  # Spring Boot ë¹Œë“œ ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  JAVA_VERSION: '17'
  GRADLE_BUILD_CMD: './gradlew clean build -x test -Dspring.profiles.active=prod'
  JAR_PATH: 'Suh-Web/build/libs/*.jar'
  APPLICATION_YML_PATH: 'Suh-Web/src/main/resources/application-prod.yml'

  # Docker ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  DOCKERFILE_PATH: './Dockerfile'
  INTERNAL_PORT: '8080'

  # ğŸ—‚ï¸ ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”, ë¹ˆê°’ì´ë©´ ë§ˆìš´íŠ¸ ì•ˆí•¨)
  PROJECT_TARGET_DIR: ""  # ì„œë²„ì˜ ë°ì´í„° ë””ë ‰í† ë¦¬ (ì˜ˆ: /volume1/projects/myapp/data)
  PROJECT_MNT_DIR: ""     # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë§ˆìš´íŠ¸ ê²½ë¡œ (ì˜ˆ: /mnt/myapp)

  # Traefik & Preview ë„ë©”ì¸ ì„¤ì • (í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€)
  TRAEFIK_NETWORK: traefik-network
  PREVIEW_DOMAIN_SUFFIX: pr.suhsaechan.kr
  PREVIEW_PORT: '8079'

  # SSH í¬íŠ¸ (ì‹œë†€ë¡œì§€ í¬íŠ¸ í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€)
  SSH_PORT: '2022'

  # Issue Helper ëŒ“ê¸€ ë§ˆì»¤ (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  # Issue ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ëª…ì„ ì¶”ì¶œí•  ë•Œ ì‚¬ìš©
  ISSUE_HELPER_MARKER: 'Guide by SUH-LAB'

  # Health Check ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  # - HEALTH_CHECK_PATH: HTTP Health Check ê²½ë¡œ (ë¹ˆê°’ì´ë©´ HTTP ì²´í¬ ê±´ë„ˆëœ€)
  # - HEALTH_CHECK_LOG_PATTERN: ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ (HTTP ì‹¤íŒ¨ ì‹œ í´ë°±)
  # - API_DOCS_PATH: API ë¬¸ì„œ URL (ë¹ˆê°’ì´ë©´ ë°°í¬ ì½”ë©˜íŠ¸ì— ë¯¸í‘œì‹œ)
  #
  # Spring Boot ê¸°ë³¸ê°’:
  #   HEALTH_CHECK_PATH: '/actuator/health'
  #   HEALTH_CHECK_LOG_PATTERN: 'Started .* in [0-9.]+ seconds'
  #   API_DOCS_PATH: '/swagger-ui.html' ë˜ëŠ” '/swagger-ui/index.html'
  HEALTH_CHECK_PATH: '/actuator/health'
  HEALTH_CHECK_LOG_PATTERN: 'Started .* in [0-9.]+ seconds'
  API_DOCS_PATH: '/docs/swagger'

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  issue_comment:
    types: [created]      # PR ëŒ“ê¸€ + Issue ëŒ“ê¸€
  issues:
    types: [closed]       # Issue ë‹«í˜ ì‹œ destroy
  pull_request:
    types: [closed]       # PR ë‹«í˜ ì‹œ destroy

permissions:
  contents: read
  pull-requests: write
  issues: write

# ===================================================================
# Jobs
# ===================================================================
jobs:
  # -----------------------------------------------------------------
  # Job 1: ëª…ë ¹ì–´ íŒŒì‹± (PR ëŒ“ê¸€ + Issue ëŒ“ê¸€ ëª¨ë‘ ì§€ì›)
  # -----------------------------------------------------------------
  check-command:
    name: ëª…ë ¹ì–´ í™•ì¸
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
      is_pr: ${{ steps.parse.outputs.is_pr }}
      custom_branch: ${{ steps.parse.outputs.custom_branch }}
      is_custom_branch: ${{ steps.parse.outputs.is_custom_branch }}
    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        if: contains(github.event.comment.body, '@suh-lab') && contains(github.event.comment.body, 'server')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: ì»¤ë§¨ë“œ íŒŒì‹±
        id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
          IS_PR: ${{ github.event.issue.pull_request != null }}
        run: |
          # PRì¸ì§€ Issueì¸ì§€ í™•ì¸
          if [[ "$IS_PR" == "true" ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ PR ëŒ“ê¸€ì—ì„œ ëª…ë ¹ì–´ ê°ì§€"
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Issue ëŒ“ê¸€ì—ì„œ ëª…ë ¹ì–´ ê°ì§€"
          fi

          # ëª…ë ¹ì–´ íŒŒì‹± (ë¸Œëœì¹˜ íŒŒë¼ë¯¸í„° ì§€ì›)
          # í˜•ì‹: @suh-lab server <command> [ë¸Œëœì¹˜ëª…]
          if [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+build([[:space:]]+([^[:space:]]+))? ]]; then
            echo "command=build" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            if [[ -n "${BASH_REMATCH[2]}" ]]; then
              echo "custom_branch=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
              echo "is_custom_branch=true" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: build (ë¸Œëœì¹˜: ${BASH_REMATCH[2]})"
            else
              echo "is_custom_branch=false" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: build"
            fi
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+destroy([[:space:]]+([^[:space:]]+))? ]]; then
            echo "command=destroy" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            if [[ -n "${BASH_REMATCH[2]}" ]]; then
              echo "custom_branch=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
              echo "is_custom_branch=true" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: destroy (ë¸Œëœì¹˜: ${BASH_REMATCH[2]})"
            else
              echo "is_custom_branch=false" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: destroy"
            fi
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+status([[:space:]]+([^[:space:]]+))? ]]; then
            echo "command=status" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            if [[ -n "${BASH_REMATCH[2]}" ]]; then
              echo "custom_branch=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
              echo "is_custom_branch=true" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: status (ë¸Œëœì¹˜: ${BASH_REMATCH[2]})"
            else
              echo "is_custom_branch=false" >> $GITHUB_OUTPUT
              echo "âœ… ëª…ë ¹ì–´ ê°ì§€: status"
            fi
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ @suh-lab server ëª…ë ¹ì–´ê°€ ì•„ë‹˜"
          fi

  # -----------------------------------------------------------------
  # Job 2-1: ë¹Œë“œ & ë°°í¬ (PR ëŒ“ê¸€ì—ì„œ ì‹¤í–‰)
  # -----------------------------------------------------------------
  build-preview-pr:
    name: Preview ë¹Œë“œ & ë°°í¬ (PR)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'true' &&
      needs.check-command.outputs.is_custom_branch != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha.substring(0, 7));
            return pr.data.number;

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ì§„í–‰ ìƒí™© ëŒ“ê¸€ ì‹œìŠ¤í…œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x gradlew

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„±
      # =================================================================
      #
      # ğŸ“‹ í•„ìˆ˜ (ëª¨ë“  Spring Boot í”„ë¡œì íŠ¸):
      #   - application-prod.yml
      #
      # ğŸ“‹ ì„ íƒ (í”„ë¡œì íŠ¸ì— ë”°ë¼ ì¶”ê°€/ì œê±°):
      #   - Firebase: firebase-admin-sdk.json, firebase-messaging-sw.js
      #   - Vertex AI: gen-lang-client-xxx.json
      #   - ê¸°íƒ€ ì„¤ì • íŒŒì¼: admin.yml, prompt.yml ë“±
      #
      # âš ï¸ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ:
      #   1. í•„ìš” ì—†ëŠ” stepì€ ì‚­ì œí•˜ì„¸ìš”
      #   2. í•„ìš”í•œ stepì„ ì¶”ê°€í•˜ì„¸ìš”
      #   3. íŒŒì¼ ê²½ë¡œë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
      # =================================================================

      # [í•„ìˆ˜] Spring Boot ì„¤ì • íŒŒì¼
      - name: "[í•„ìˆ˜] application-prod.yml ìƒì„±"
        run: |
          mkdir -p $(dirname ${{ env.APPLICATION_YML_PATH }})
          cat << 'EOF' > ${{ env.APPLICATION_YML_PATH }}
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF

      # [ì„ íƒ] ì•„ë˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œí•˜ì„¸ìš”.
      # - name: "[ì„ íƒ] Vertex AI Service Account Key ìƒì„±"
      #   env:
      #     VERTEX_SA_KEY: ${{ secrets.VERTEX_SA_KEY }}
      #   run: |
      #     echo "$VERTEX_SA_KEY" | sed 's/\\n/\n/g' > ./Suh-Web/src/main/resources/vertex-ai-key.json

      # - name: "[ì„ íƒ] Firebase Admin SDK ìƒì„±"
      #   env:
      #     FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
      #   run: |
      #     echo "$FIREBASE_KEY_JSON" | sed 's/\\n/\n/g' > ./Suh-Web/src/main/resources/firebase-admin-sdk.json

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2 ë] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„± ë
      # =================================================================

      - name: Gradle ë¹Œë“œ
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ì§„í–‰ ìƒí™© - ë¹Œë“œ ì™„ë£Œ
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ github.event.issue.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì§„í–‰ ìƒí™© - Docker ì™„ë£Œ
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # ë³€ìˆ˜ ì„¤ì •
            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${PR_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ PR Preview ë°°í¬ ì‹œì‘"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ PR ë²ˆí˜¸: #${PR_NUMBER}"
            echo "ğŸ“› ì»¨í…Œì´ë„ˆ: ${CONTAINER_NAME}"
            echo "ğŸŒ ë„ë©”ì¸: ${DOMAIN}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì˜µì…˜ êµ¬ì„±
            VOLUME_OPTS="-v /etc/localtime:/etc/localtime:ro"
            if [ -n "${{ env.PROJECT_TARGET_DIR }}" ] && [ -n "${{ env.PROJECT_MNT_DIR }}" ]; then
              VOLUME_OPTS="$VOLUME_OPTS -v ${{ env.PROJECT_TARGET_DIR }}:${{ env.PROJECT_MNT_DIR }}"
            fi

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              $VOLUME_OPTS \
              "${IMAGE}"

            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # Health Check (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°) - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
            # 1. HEALTH_CHECK_PATHê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ HTTP ì²´í¬ ì‹œë„
            # 2. í´ë°±: ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ (HEALTH_CHECK_LOG_PATTERN)
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            echo ""
            echo "â³ Health Check ì‹œì‘ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°)..."
            HEALTH_PATH="${{ env.HEALTH_CHECK_PATH }}"
            LOG_PATTERN="${{ env.HEALTH_CHECK_LOG_PATTERN }}"
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ!"
                echo ""
                echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. HTTP Health Check ì‹œë„ (HEALTH_CHECK_PATHê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
                if [ -n "$HEALTH_PATH" ]; then
                  HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- "http://localhost:${INTERNAL_PORT}${HEALTH_PATH}" 2>/dev/null || echo "")

                  # Spring Actuator ì‘ë‹µ í™•ì¸ ({"status":"UP"}) ë˜ëŠ” ì¼ë°˜ HTTP ì‘ë‹µ
                  if echo "$HEALTH" | grep -q '"status":"UP"' || [ -n "$HEALTH" ]; then
                    echo "âœ… ì •ìƒ ê¸°ë™ í™•ì¸! (HTTP ì‘ë‹µ: ${HEALTH_PATH})"
                    HEALTH_CHECK_PASSED=true
                    HEALTH_CHECK_METHOD="HTTP"
                    break
                  fi
                fi

                # 3. HTTP ì‘ë‹µ ì—†ìœ¼ë©´ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í´ë°±
                if [ -n "$LOG_PATTERN" ]; then
                  STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "$LOG_PATTERN" || echo "")

                  if [ -n "$STARTED" ]; then
                    echo "âœ… ì •ìƒ ê¸°ë™ í™•ì¸! (ë¡œê·¸ íŒ¨í„´)"
                    echo "   $STARTED"
                    HEALTH_CHECK_PASSED=true
                    HEALTH_CHECK_METHOD="Log"
                    break
                  fi
                fi
              fi

              echo "â³ ëŒ€ê¸° ì¤‘... ($RETRY_COUNT/$MAX_RETRIES) - ìƒíƒœ: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "âŒ Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
              echo ""
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ë°°í¬ ë° Health Check ì™„ë£Œ! (ë°©ì‹: ${HEALTH_CHECK_METHOD})"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const apiDocsPath = '${{ env.API_DOCS_PATH }}';
            const prNumber = context.issue.number;
            const domain = `${projectName}-pr-${prNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const sha = '${{ steps.pr.outputs.sha }}';

            // Preview í™˜ê²½ í…Œì´ë¸” êµ¬ì„± (API_DOCS_PATHê°€ ìˆì„ ë•Œë§Œ API Docs í–‰ ì¶”ê°€)
            const envRows = [
              `| **Preview URL** | ${previewUrl} |`,
            ];
            if (apiDocsPath) {
              envRows.push(`| **API Docs** | ${previewUrl}${apiDocsPath} |`);
            }
            envRows.push(`| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`);
            envRows.push(`| **ì»¤ë°‹** | \`${sha}\` |`);

            const branchName = '${{ steps.pr.outputs.ref }}';

            const body = [
              '## âœ… PR Preview ë°°í¬ ì™„ë£Œ!',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              '### ğŸŒ Preview í™˜ê²½',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              ...envRows,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              '| `@suh-lab server build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
              '| `@suh-lab server destroy` | Preview í™˜ê²½ ì‚­ì œ |',
              '| `@suh-lab server status` | í˜„ì¬ ìƒíƒœ í™•ì¸ |',
              '',
              '<details>',
              '<summary>ğŸ”§ ê³ ê¸‰ ëª…ë ¹ì–´ (ë‹¤ë¥¸ Issue/PRì—ì„œ ì œì–´)</summary>',
              '',
              '```',
              `@suh-lab server build ${branchName}`,
              `@suh-lab server destroy ${branchName}`,
              `@suh-lab server status ${branchName}`,
              '```',
              '</details>',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // ì§„í–‰ ìƒí™©ì— ë”°ë¼ ì–´ë””ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ í‘œì‹œ
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            // ì‹¤íŒ¨ ì§€ì  íŒë‹¨ - ì´ˆê¸° ë‹¨ê³„ ì‹¤íŒ¨ë„ êµ¬ë¶„
            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              // ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„± ì „ ì‹¤íŒ¨ (ì´ˆê¸°í™” ë‹¨ê³„)
              buildStatus = 'âš ï¸ ì´ˆê¸°í™” ì‹¤íŒ¨';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              // ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âŒ ì‹¤íŒ¨';
              dockerStatus = 'â¸ï¸ ëŒ€ê¸°';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
            } else if (!dockerDuration || dockerDuration === '') {
              // Docker ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âŒ ì‹¤íŒ¨';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
              buildTime = buildDuration;
            } else {
              // ë°°í¬ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âœ… ì™„ë£Œ';
              deployStatus = 'âŒ ì‹¤íŒ¨';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## âŒ PR Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | ${buildStatus} | ${buildTime} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | ${dockerStatus} | ${dockerTime} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | ${deployStatus} | - |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (Spring Boot ê¸°ë™ ì˜¤ë¥˜)',
              '- Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ ë‚´ ê¸°ë™ ì™„ë£Œ ì•ˆë¨)',
              '',
              '### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„',
              '1. ìœ„ ë§í¬ì—ì„œ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: `@suh-lab server build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            // ì§„í–‰ ìƒí™© ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 2-2: Issueì—ì„œ ë¸Œëœì¹˜ëª… ì¶”ì¶œ
  # -----------------------------------------------------------------
  get-branch-from-issue:
    name: Issueì—ì„œ ë¸Œëœì¹˜ ì¶”ì¶œ
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.is_pr == 'false' &&
      needs.check-command.outputs.is_custom_branch != 'true'
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.extract.outputs.branch }}
      found: ${{ steps.extract.outputs.found }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
    steps:
      - name: Issue ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ëª… ì¶”ì¶œ
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            console.log(`ğŸ” Issue #${issueNumber}ì—ì„œ ë¸Œëœì¹˜ ê²€ìƒ‰ ì¤‘...`);
            console.log(`ğŸ“ ë§ˆì»¤: ${marker}`);

            // Issueì˜ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // ë¸Œëœì¹˜ ì¶”ì¶œ íŒ¨í„´ (ë§ˆì»¤ì™€ ë¬´ê´€í•˜ê²Œ ë™ì¼í•œ í˜•ì‹)
            // "### ë¸Œëœì¹˜" ë˜ëŠ” "### ë¸Œëœì¹˜ëª…" ë‘˜ ë‹¤ ë§¤ì¹­
            const branchRegex = /###\s*ë¸Œëœì¹˜(?:ëª…)?\s*\n```\s*\n([^\n]+)\s*\n```/;

            for (const comment of comments.data) {
              // ë§ˆì»¤ê°€ í¬í•¨ëœ ëŒ“ê¸€ ì°¾ê¸°
              if (comment.body.includes(marker)) {
                const match = comment.body.match(branchRegex);
                if (match) {
                  const branchName = match[1].trim();
                  core.setOutput('branch', branchName);
                  core.setOutput('found', 'true');
                  core.setOutput('issue_number', issueNumber);
                  console.log(`âœ… ë¸Œëœì¹˜ ë°œê²¬: ${branchName}`);
                  return;
                }
              }
            }

            // ë¸Œëœì¹˜ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° - ì—ëŸ¬ê°€ ì•„ë‹˜, gracefulí•˜ê²Œ ì²˜ë¦¬
            core.setOutput('found', 'false');
            core.setOutput('issue_number', issueNumber);
            console.log('âš ï¸ Issue Helper ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      - name: ë¸Œëœì¹˜ ì—†ìŒ ì•Œë¦¼
        if: steps.extract.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            const body = [
              '## âš ï¸ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **Issue** | #${issueNumber} |`,
              `| **ë§ˆì»¤** | \`${marker}\` |`,
              '',
              '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
              '1. Issue Helper ëŒ“ê¸€ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '2. ëŒ“ê¸€ì— `### ë¸Œëœì¹˜` ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '3. `ISSUE_HELPER_MARKER` í™˜ê²½ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 2-3: ë¹Œë“œ & ë°°í¬ (Issue ëŒ“ê¸€ì—ì„œ ì‹¤í–‰)
  # -----------------------------------------------------------------
  build-preview-issue:
    name: Preview ë¹Œë“œ & ë°°í¬ (Issue)
    needs: [check-command, get-branch-from-issue]
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'false' &&
      needs.check-command.outputs.is_custom_branch != 'true' &&
      needs.get-branch-from-issue.outputs.found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ë¸Œëœì¹˜ ì¡´ì¬ í™•ì¸
        id: check_branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};

            console.log(`ğŸ” ë¸Œëœì¹˜ ì¡´ì¬ í™•ì¸: ${branchName}`);

            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              core.setOutput('exists', 'true');
              console.log(`âœ… ë¸Œëœì¹˜ ì¡´ì¬: ${branchName}`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                console.log(`âŒ ë¸Œëœì¹˜ ì—†ìŒ: ${branchName}`);

                // ë¸Œëœì¹˜ ì—†ìŒ ì•Œë¦¼ ëŒ“ê¸€
                const body = [
                  '## âŒ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                  '',
                  '| í•­ëª© | ê°’ |',
                  '|------|-----|',
                  `| **Issue** | #${issueNumber} |`,
                  `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
                  '',
                  '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
                  '1. ë¸Œëœì¹˜ê°€ pushë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '2. ë¸Œëœì¹˜ëª…ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”',
                  '3. ë¸Œëœì¹˜ê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '',
                  '---',
                  '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: body
                });
              } else {
                throw error;
              }
            }

      - name: ë¸Œëœì¹˜ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          echo "âš ï¸ ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0

      - name: Issue ì •ë³´ ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        id: issue
        run: |
          echo "ref=${{ needs.get-branch-from-issue.outputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ needs.get-branch-from-issue.outputs.issue_number }}" >> $GITHUB_OUTPUT
          # ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ SHA ê°€ì ¸ì˜¤ê¸°
          echo "sha=$(git ls-remote https://github.com/${{ github.repository }}.git refs/heads/${{ needs.get-branch-from-issue.outputs.branch_name }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ì§„í–‰ ìƒí™© ëŒ“ê¸€ ì‹œìŠ¤í…œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        if: steps.check_branch.outputs.exists == 'true'
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-branch-from-issue.outputs.branch_name }}

      - name: JDK ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle ê¶Œí•œ ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        run: chmod +x gradlew

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„±
      # =================================================================
      - name: "[í•„ìˆ˜] application-prod.yml ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          mkdir -p $(dirname ${{ env.APPLICATION_YML_PATH }})
          cat << 'EOF' > ${{ env.APPLICATION_YML_PATH }}
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF
      # =================================================================
      # âš ï¸ [ì˜ì—­ 2 ë] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„± ë
      # =================================================================

      - name: Gradle ë¹Œë“œ
        if: steps.check_branch.outputs.exists == 'true'
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ì§„í–‰ ìƒí™© - ë¹Œë“œ ì™„ë£Œ
        if: steps.check_branch.outputs.exists == 'true'
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker ë¡œê·¸ì¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ needs.get-branch-from-issue.outputs.issue_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì§„í–‰ ìƒí™© - Docker ì™„ë£Œ
        if: steps.check_branch.outputs.exists == 'true'
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ì„œë²„ì— ë°°í¬
        if: steps.check_branch.outputs.exists == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # ë³€ìˆ˜ ì„¤ì •
            ISSUE_NUMBER=${{ needs.get-branch-from-issue.outputs.issue_number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${ISSUE_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${ISSUE_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${ISSUE_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Issue Preview ë°°í¬ ì‹œì‘"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ Issue ë²ˆí˜¸: #${ISSUE_NUMBER}"
            echo "ğŸ“› ì»¨í…Œì´ë„ˆ: ${CONTAINER_NAME}"
            echo "ğŸŒ ë„ë©”ì¸: ${DOMAIN}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì˜µì…˜ êµ¬ì„±
            VOLUME_OPTS="-v /etc/localtime:/etc/localtime:ro"
            if [ -n "${{ env.PROJECT_TARGET_DIR }}" ] && [ -n "${{ env.PROJECT_MNT_DIR }}" ]; then
              VOLUME_OPTS="$VOLUME_OPTS -v ${{ env.PROJECT_TARGET_DIR }}:${{ env.PROJECT_MNT_DIR }}"
            fi

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              $VOLUME_OPTS \
              "${IMAGE}"

            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # Health Check (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°) - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
            # 1. HEALTH_CHECK_PATHê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ HTTP ì²´í¬ ì‹œë„
            # 2. í´ë°±: ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ (HEALTH_CHECK_LOG_PATTERN)
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            echo ""
            echo "â³ Health Check ì‹œì‘ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°)..."
            HEALTH_PATH="${{ env.HEALTH_CHECK_PATH }}"
            LOG_PATTERN="${{ env.HEALTH_CHECK_LOG_PATTERN }}"
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ!"
                echo ""
                echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. HTTP Health Check ì‹œë„ (HEALTH_CHECK_PATHê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
                if [ -n "$HEALTH_PATH" ]; then
                  HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- "http://localhost:${INTERNAL_PORT}${HEALTH_PATH}" 2>/dev/null || echo "")

                  # Spring Actuator ì‘ë‹µ í™•ì¸ ({"status":"UP"}) ë˜ëŠ” ì¼ë°˜ HTTP ì‘ë‹µ
                  if echo "$HEALTH" | grep -q '"status":"UP"' || [ -n "$HEALTH" ]; then
                    echo "âœ… ì •ìƒ ê¸°ë™ í™•ì¸! (HTTP ì‘ë‹µ: ${HEALTH_PATH})"
                    HEALTH_CHECK_PASSED=true
                    HEALTH_CHECK_METHOD="HTTP"
                    break
                  fi
                fi

                # 3. HTTP ì‘ë‹µ ì—†ìœ¼ë©´ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í´ë°±
                if [ -n "$LOG_PATTERN" ]; then
                  STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "$LOG_PATTERN" || echo "")

                  if [ -n "$STARTED" ]; then
                    echo "âœ… ì •ìƒ ê¸°ë™ í™•ì¸! (ë¡œê·¸ íŒ¨í„´)"
                    echo "   $STARTED"
                    HEALTH_CHECK_PASSED=true
                    HEALTH_CHECK_METHOD="Log"
                    break
                  fi
                fi
              fi

              echo "â³ ëŒ€ê¸° ì¤‘... ($RETRY_COUNT/$MAX_RETRIES) - ìƒíƒœ: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "âŒ Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
              echo ""
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ë°°í¬ ë° Health Check ì™„ë£Œ! (ë°©ì‹: ${HEALTH_CHECK_METHOD})"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const apiDocsPath = '${{ env.API_DOCS_PATH }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const domain = `${projectName}-pr-${issueNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const sha = '${{ steps.issue.outputs.sha }}';

            // Preview í™˜ê²½ í…Œì´ë¸” êµ¬ì„± (API_DOCS_PATHê°€ ìˆì„ ë•Œë§Œ API Docs í–‰ ì¶”ê°€)
            const envRows = [
              `| **Preview URL** | ${previewUrl} |`,
            ];
            if (apiDocsPath) {
              envRows.push(`| **API Docs** | ${previewUrl}${apiDocsPath} |`);
            }
            envRows.push(`| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${issueNumber}\` |`);
            envRows.push(`| **ë¸Œëœì¹˜** | \`${branchName}\` |`);
            envRows.push(`| **ì»¤ë°‹** | \`${sha}\` |`);

            const body = [
              '## âœ… Issue Preview ë°°í¬ ì™„ë£Œ!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              '### ğŸŒ Preview í™˜ê²½',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              ...envRows,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              '| `@suh-lab server build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
              '| `@suh-lab server destroy` | Preview í™˜ê²½ ì‚­ì œ |',
              '| `@suh-lab server status` | í˜„ì¬ ìƒíƒœ í™•ì¸ |',
              '',
              '<details>',
              '<summary>ğŸ”§ ê³ ê¸‰ ëª…ë ¹ì–´ (ë‹¤ë¥¸ Issue/PRì—ì„œ ì œì–´)</summary>',
              '',
              '```',
              `@suh-lab server build ${branchName}`,
              `@suh-lab server destroy ${branchName}`,
              `@suh-lab server status ${branchName}`,
              '```',
              '</details>',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure() && steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              buildStatus = 'âš ï¸ ì´ˆê¸°í™” ì‹¤íŒ¨';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              buildStatus = 'âŒ ì‹¤íŒ¨';
              dockerStatus = 'â¸ï¸ ëŒ€ê¸°';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
            } else if (!dockerDuration || dockerDuration === '') {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âŒ ì‹¤íŒ¨';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
              buildTime = buildDuration;
            } else {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âœ… ì™„ë£Œ';
              deployStatus = 'âŒ ì‹¤íŒ¨';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## âŒ Issue Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | ${buildStatus} | ${buildTime} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | ${dockerStatus} | ${dockerTime} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | ${deployStatus} | - |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (Spring Boot ê¸°ë™ ì˜¤ë¥˜)',
              '- Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ ë‚´ ê¸°ë™ ì™„ë£Œ ì•ˆë¨)',
              '',
              '### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„',
              '1. ìœ„ ë§í¬ì—ì„œ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: `@suh-lab server build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 3: Preview ì‚­ì œ (PR/Issue ë‹«í˜ ë˜ëŠ” destroy ëª…ë ¹)
  # -----------------------------------------------------------------
  destroy-preview:
    name: Preview ì‚­ì œ
    # needs ì˜ì¡´ì„± ì œê±°: PR/Issue ë‹«í˜ ì´ë²¤íŠ¸ì—ì„œë„ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•¨
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed') ||
      (github.event_name == 'issues' && github.event.action == 'closed') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@suh-lab') && contains(github.event.comment.body, 'server destroy'))
    runs-on: ubuntu-latest
    steps:
      - name: PR/Issue ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        id: pr_number
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=comment" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "type=pr_closed" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue_closed" >> $GITHUB_OUTPUT
          fi

      - name: ì»¨í…Œì´ë„ˆ & ì´ë¯¸ì§€ ì‚­ì œ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            PR_NUMBER=${{ steps.pr_number.outputs.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—‘ï¸ Preview ì‚­ì œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ ë²ˆí˜¸: #${PR_NUMBER}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ³ ì»¨í…Œì´ë„ˆ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ì´ë¯¸ì§€ ì‚­ì œ
            echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rmi "${IMAGE}" 2>/dev/null || true

            echo "âœ… ì‚­ì œ ì™„ë£Œ!"

      - name: ì‚­ì œ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: |
          github.event_name == 'issue_comment' ||
          (github.event_name == 'pull_request' && github.event.action == 'closed') ||
          (github.event_name == 'issues' && github.event.action == 'closed')
        uses: actions/github-script@v7
        with:
          script: |
            const number = ${{ steps.pr_number.outputs.number }};
            const projectName = '${{ env.PROJECT_NAME }}';

            const body = [
              '## ğŸ—‘ï¸ Preview í™˜ê²½ ì‚­ì œ ì™„ë£Œ!',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
              '| **ìƒíƒœ** | ì‚­ì œë¨ |',
              '',
              'ë‹¤ì‹œ ë°°í¬í•˜ë ¤ë©´: `@suh-lab server build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR/Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 4: ìƒíƒœ í™•ì¸ (PR/Issue ëª¨ë‘ ì§€ì›)
  # -----------------------------------------------------------------
  check-status:
    name: Preview ìƒíƒœ í™•ì¸
    needs: check-command
    if: needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        id: status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Preview ìƒíƒœ í™•ì¸"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "STATUS=running"
              echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
              docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
            else
              echo "STATUS=not_found"
              echo "âŒ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ (ì‹¤í–‰ ì¤‘)
        uses: appleboy/ssh-action@v1.0.3
        id: check_running
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"
            docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ ì‘ì„±
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const domain = `${projectName}-pr-${number}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const isRunning = '${{ steps.check_running.outcome }}' === 'success';
            const isPr = '${{ needs.check-command.outputs.is_pr }}' === 'true';
            const contextType = isPr ? 'PR' : 'Issue';

            let body;
            if (isRunning) {
              body = [
                '## âœ… Preview í™˜ê²½ ì‹¤í–‰ ì¤‘',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **Preview URL** | ${previewUrl} |`,
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
                '| **ìƒíƒœ** | ğŸŸ¢ Running |',
                '',
                '### ğŸ“‹ ëª…ë ¹ì–´',
                '| ëª…ë ¹ì–´ | ì„¤ëª… |',
                '|--------|------|',
                '| `@suh-lab server build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
                '| `@suh-lab server destroy` | Preview í™˜ê²½ ì‚­ì œ |',
                '',
                '---',
                `*ğŸ¤– ì´ ëŒ“ê¸€ì€ ${contextType} Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              ].join('\n');
            } else {
              body = [
                '## âŒ Preview í™˜ê²½ ì—†ìŒ',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
                '| **ìƒíƒœ** | ğŸ”´ Not Found |',
                '',
                'ë°°í¬í•˜ë ¤ë©´: `@suh-lab server build`',
                '',
                '---',
                `*ğŸ¤– ì´ ëŒ“ê¸€ì€ ${contextType} Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });

  # ============================================================
  # Custom Branch Preview Jobs
  # íŠ¹ì • ë¸Œëœì¹˜ë¥¼ ì§€ì •í•˜ì—¬ ë¹Œë“œ/ì‚­ì œ/ìƒíƒœ í™•ì¸í•˜ëŠ” ê¸°ëŠ¥
  # ëª…ë ¹ì–´: @suh-lab server build <ë¸Œëœì¹˜ëª…>
  # ============================================================

  build-preview-custom-branch:
    name: Preview ë¹Œë“œ & ë°°í¬ (Custom Branch)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_custom_branch == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ Issue ë²ˆí˜¸ ì¶”ì¶œ
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.check-command.outputs.custom_branch }}';
            const issueMatch = branchName.match(/#(\d+)/);

            if (issueMatch) {
              core.setOutput('issue_number', issueMatch[1]);
              core.setOutput('use_hash', 'false');
              core.setOutput('container_suffix', `pr-${issueMatch[1]}`);
            } else {
              // í•´ì‹œ ìƒì„±
              let hash = 0;
              for (let i = 0; i < branchName.length; i++) {
                const char = branchName.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
              }
              const hashStr = Math.abs(hash).toString(16).slice(-6).padStart(6, '0');
              core.setOutput('container_suffix', `custom-${hashStr}`);
              core.setOutput('use_hash', 'true');
            }

            core.setOutput('branch_name', branchName);

      - name: ë¸Œëœì¹˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        id: check_branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: ë¸Œëœì¹˜ ì—†ìŒ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: steps.check_branch.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract.outputs.branch_name }}';

            const body = [
              '## âŒ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              '',
              '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
              '1. ë¸Œëœì¹˜ëª…ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¸Œëœì¹˜ê°€ pushë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '3. ë¸Œëœì¹˜ê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            core.setFailed('ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + branchName);

      - name: ì²´í¬ì•„ì›ƒ
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.extract.outputs.branch_name }}

      - name: ìµœì‹  ì»¤ë°‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        if: steps.check_branch.outputs.exists == 'true'
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ì§„í–‰ ìƒí™© ì½”ë©˜íŠ¸ ì‘ì„±
        if: steps.check_branch.outputs.exists == 'true'
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const projectName = '${{ env.PROJECT_NAME }}';
            const containerSuffix = '${{ steps.extract.outputs.container_suffix }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const sha = '${{ steps.commit.outputs.sha }}';

            const body = [
              '## ğŸš€ Custom Branch Preview ë°°í¬ ì‹œì‘',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              `**ì»¤ë°‹**: \`${sha}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            core.setOutput('comment_id', comment.data.id);

      - name: JDK ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Gradle ìºì‹œ
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Gradle ë¹Œë“œ
        if: steps.check_branch.outputs.exists == 'true'
        id: build
        run: |
          BUILD_START=$(date +%s)
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test --no-daemon
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "duration=${BUILD_DURATION}s" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ì™„ë£Œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        if: steps.check_branch.outputs.exists == 'true'
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const sha = '${{ steps.commit.outputs.sha }}';
            const buildDuration = '${{ steps.build.outputs.duration }}';

            const body = [
              '## ğŸš€ Custom Branch Preview ë°°í¬ ì‹œì‘',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              `**ì»¤ë°‹**: \`${sha}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);

      - name: Docker Hub ë¡œê·¸ì¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
        if: steps.check_branch.outputs.exists == 'true'
        id: docker
        run: |
          DOCKER_START=$(date +%s)
          CONTAINER_SUFFIX="${{ steps.extract.outputs.container_suffix }}"
          IMAGE_TAG="${{ secrets.DOCKER_USERNAME }}/${{ env.PROJECT_NAME }}:${CONTAINER_SUFFIX}"
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG
          DOCKER_END=$(date +%s)
          DOCKER_DURATION=$((DOCKER_END - DOCKER_START))
          echo "duration=${DOCKER_DURATION}s" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Docker ì™„ë£Œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        if: steps.check_branch.outputs.exists == 'true'
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const sha = '${{ steps.commit.outputs.sha }}';
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker.outputs.duration }}';

            const body = [
              '## ğŸš€ Custom Branch Preview ë°°í¬ ì‹œì‘',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              `**ì»¤ë°‹**: \`${sha}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('docker_duration', dockerDuration);

      - name: ì„œë²„ ë°°í¬
        if: steps.check_branch.outputs.exists == 'true'
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            export PATH=$PATH:/usr/local/bin

            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_SUFFIX="${{ steps.extract.outputs.container_suffix }}"
            CONTAINER_NAME="${PROJECT_NAME}-${CONTAINER_SUFFIX}"
            IMAGE_TAG="${{ steps.docker.outputs.image_tag }}"
            PREVIEW_PORT="${{ env.PREVIEW_PORT }}"
            DOMAIN_SUFFIX="${{ env.PREVIEW_DOMAIN_SUFFIX }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Custom Branch Preview ë°°í¬"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            docker pull $IMAGE_TAG

            if docker ps -a --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ: ${CONTAINER_NAME}"
              docker stop ${CONTAINER_NAME} || true
              docker rm ${CONTAINER_NAME} || true
            fi

            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘: ${CONTAINER_NAME}"
            docker run -d \
              --name ${CONTAINER_NAME} \
              --network traefik-network \
              -l "traefik.enable=true" \
              -l "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${CONTAINER_NAME}.${DOMAIN_SUFFIX}\`)" \
              -l "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              -l "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${PREVIEW_PORT}" \
              ${IMAGE_TAG}

            echo "â³ Health Check ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)..."
            for i in {1..12}; do
              if docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
                echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸ë¨"
                break
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/12)"
              sleep 5
            done

            if ! docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
              exit 1
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ Preview URL: http://${CONTAINER_NAME}.${DOMAIN_SUFFIX}:${PREVIEW_PORT}"

      - name: ë°°í¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡
        if: steps.check_branch.outputs.exists == 'true'
        id: deploy_time
        run: echo "duration=ì™„ë£Œ" >> $GITHUB_OUTPUT

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const containerSuffix = '${{ steps.extract.outputs.container_suffix }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const sha = '${{ steps.commit.outputs.sha }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const apiDocsPath = '${{ env.API_DOCS_PATH }}';

            const containerName = `${projectName}-${containerSuffix}`;
            const previewUrl = `http://${containerName}.${domainSuffix}:${previewPort}`;

            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployDuration = '${{ steps.deploy_time.outputs.duration }}';

            const envRows = [
              `| **Preview URL** | ${previewUrl} |`,
            ];
            if (apiDocsPath) {
              envRows.push(`| **API Docs** | ${previewUrl}${apiDocsPath} |`);
            }
            envRows.push(`| **ì»¨í…Œì´ë„ˆ** | \`${containerName}\` |`);
            envRows.push(`| **ë¸Œëœì¹˜** | \`${branchName}\` |`);
            envRows.push(`| **ì»¤ë°‹** | \`${sha}\` |`);

            const body = [
              '## âœ… Custom Branch Preview ë°°í¬ ì™„ë£Œ!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              '### ğŸŒ Preview í™˜ê²½',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              ...envRows,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              `| \`@suh-lab server build ${branchName}\` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |`,
              `| \`@suh-lab server destroy ${branchName}\` | Preview í™˜ê²½ ì‚­ì œ |`,
              `| \`@suh-lab server status ${branchName}\` | í˜„ì¬ ìƒíƒœ í™•ì¸ |`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure() && steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              buildStatus = 'âš ï¸ ì´ˆê¸°í™” ì‹¤íŒ¨';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              buildStatus = 'âŒ ì‹¤íŒ¨';
              dockerStatus = 'â¸ï¸ ëŒ€ê¸°';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
            } else if (!dockerDuration || dockerDuration === '') {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âŒ ì‹¤íŒ¨';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
              buildTime = buildDuration;
            } else {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âœ… ì™„ë£Œ';
              deployStatus = 'âŒ ì‹¤íŒ¨';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## âŒ Custom Branch Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | ${buildStatus} | ${buildTime} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | ${dockerStatus} | ${dockerTime} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | ${deployStatus} | - |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì„œë²„ ì—°ê²° ë¬¸ì œ',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  destroy-preview-custom-branch:
    name: Preview ì‚­ì œ (Custom Branch)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'destroy' &&
      needs.check-command.outputs.is_custom_branch == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì»¨í…Œì´ë„ˆ suffix ì¶”ì¶œ
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.check-command.outputs.custom_branch }}';
            const issueMatch = branchName.match(/#(\d+)/);

            if (issueMatch) {
              core.setOutput('container_suffix', `pr-${issueMatch[1]}`);
            } else {
              let hash = 0;
              for (let i = 0; i < branchName.length; i++) {
                const char = branchName.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
              }
              const hashStr = Math.abs(hash).toString(16).slice(-6).padStart(6, '0');
              core.setOutput('container_suffix', `custom-${hashStr}`);
            }

            core.setOutput('branch_name', branchName);

      - name: ì»¨í…Œì´ë„ˆ ì‚­ì œ
        id: destroy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            export PATH=$PATH:/usr/local/bin

            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_SUFFIX="${{ steps.extract.outputs.container_suffix }}"
            CONTAINER_NAME="${PROJECT_NAME}-${CONTAINER_SUFFIX}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—‘ï¸ Custom Branch Preview ì‚­ì œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if docker ps -a --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "ğŸ—‘ï¸ ì»¨í…Œì´ë„ˆ ì‚­ì œ ì¤‘: ${CONTAINER_NAME}"
              docker stop ${CONTAINER_NAME} || true
              docker rm ${CONTAINER_NAME} || true
              echo "DESTROYED=true"
            else
              echo "â„¹ï¸ ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: ${CONTAINER_NAME}"
              echo "DESTROYED=false"
            fi

      - name: ì‚­ì œ í™•ì¸ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const projectName = '${{ env.PROJECT_NAME }}';
            const containerSuffix = '${{ steps.extract.outputs.container_suffix }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const containerName = `${projectName}-${containerSuffix}`;

            const body = [
              '## ğŸ—‘ï¸ Custom Branch Preview ì‚­ì œ ì™„ë£Œ',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¨í…Œì´ë„ˆ** | \`${containerName}\` |`,
              '',
              `ë‹¤ì‹œ ë°°í¬í•˜ë ¤ë©´: \`@suh-lab server build ${branchName}\``,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  check-status-custom-branch:
    name: Preview ìƒíƒœ í™•ì¸ (Custom Branch)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'status' &&
      needs.check-command.outputs.is_custom_branch == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì»¨í…Œì´ë„ˆ suffix ì¶”ì¶œ
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.check-command.outputs.custom_branch }}';
            const issueMatch = branchName.match(/#(\d+)/);

            if (issueMatch) {
              core.setOutput('container_suffix', `pr-${issueMatch[1]}`);
            } else {
              let hash = 0;
              for (let i = 0; i < branchName.length; i++) {
                const char = branchName.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
              }
              const hashStr = Math.abs(hash).toString(16).slice(-6).padStart(6, '0');
              core.setOutput('container_suffix', `custom-${hashStr}`);
            }

            core.setOutput('branch_name', branchName);

      - name: ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        id: check_running
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            export PATH=$PATH:/usr/local/bin

            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_SUFFIX="${{ steps.extract.outputs.container_suffix }}"
            CONTAINER_NAME="${PROJECT_NAME}-${CONTAINER_SUFFIX}"

            docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ ì‘ì„±
        uses: actions/github-script@v7
        with:
          script: |
            const projectName = '${{ env.PROJECT_NAME }}';
            const containerSuffix = '${{ steps.extract.outputs.container_suffix }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';

            const containerName = `${projectName}-${containerSuffix}`;
            const previewUrl = `http://${containerName}.${domainSuffix}:${previewPort}`;
            const isRunning = '${{ steps.check_running.outcome }}' === 'success';

            let body;
            if (isRunning) {
              body = [
                '## âœ… Custom Branch Preview í™˜ê²½ ì‹¤í–‰ ì¤‘',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
                `| **Preview URL** | ${previewUrl} |`,
                `| **ì»¨í…Œì´ë„ˆ** | \`${containerName}\` |`,
                '| **ìƒíƒœ** | ğŸŸ¢ Running |',
                '',
                '### ğŸ“‹ ëª…ë ¹ì–´',
                '| ëª…ë ¹ì–´ | ì„¤ëª… |',
                '|--------|------|',
                `| \`@suh-lab server build ${branchName}\` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |`,
                `| \`@suh-lab server destroy ${branchName}\` | Preview í™˜ê²½ ì‚­ì œ |`,
                '',
                '---',
                '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
              ].join('\n');
            } else {
              body = [
                '## âŒ Custom Branch Preview í™˜ê²½ ì—†ìŒ',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
                `| **ì»¨í…Œì´ë„ˆ** | \`${containerName}\` |`,
                '| **ìƒíƒœ** | ğŸ”´ Not Found |',
                '',
                `ë°°í¬í•˜ë ¤ë©´: \`@suh-lab server build ${branchName}\``,
                '',
                '---',
                '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
